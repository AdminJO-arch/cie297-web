<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CIE-297 | Monitoreo en Tiempo Real</title>
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b1424;--card:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    a{color:#8ab4ff;text-decoration:none}
    .brand{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;background:var(--card);position:sticky;top:0;z-index:5;border-bottom:1px solid var(--line)}
    .brand img{width:26px;height:26px}
    .brand h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .hidden{display:none !important}
    .row{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .section h3{margin:0 0 10px 0}
    .btn{background:#1d2a44;border:1px solid var(--line);padding:.6rem 1rem;border-radius:10px;color:var(--text);cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-primary{background:#243654}
    .badge{padding:.25rem .6rem;border-radius:999px;border:1px solid var(--line);font-weight:700}
    .baja{background:rgba(34,197,94,.15);border-color:#22c55e;color:#22c55e}
    .media{background:rgba(245,158,11,.15);border-color:#f59e0b;color:#f59e0b}
    .alta{background:rgba(239,68,68,.15);border-color:#ef4444;color:#ef4444}
    /* AUTH ONLY LAYOUT */
    #auth{display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 60px)}
    .auth-card{width:min(680px,92%);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    input,select,textarea{width:100%;background:#0f1a31;border:1px solid var(--line);border-radius:10px;color:var(--text);padding:.6rem .8rem}
    textarea{min-height:110px;resize:vertical}
    /* APP */
    #app{display:none} /* <- OCULTO HASTA LOGIN */
    #map{height:340px;border:1px dashed var(--line);border-radius:10px}
    .list{display:flex;flex-direction:column;gap:10px;max-height:340px;overflow:auto}
    .item{background:var(--soft);border:1px solid var(--line);padding:12px;border-radius:14px}
    .muted{color:var(--muted);font-size:12px}
    .topbar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .pill{padding:.2rem .6rem;border-radius:999px;border:1px solid var(--line);font-weight:700}
  </style>
</head>
<body>
  <div class="brand">
    <img src="assets/logo.png" alt="logo" />
    <h1>CIE-297 | Monitoreo en Tiempo Real</h1>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <span id="who" class="muted"></span>
      <button id="logoutBtn" class="btn hidden">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- ====== AUTH (√öNICO CONTENIDO VISIBLE SIN SESI√ìN) ====== -->
  <div id="auth">
    <div class="auth-card">
      <h2 style="margin:0 0 10px 0">Acceso</h2>
      <p class="muted" style="margin:0 0 12px">Primero inicia sesi√≥n o crea una cuenta. El contenido del sistema se mostrar√° despu√©s.</p>

      <div class="grid2">
        <div>
          <h3 style="margin:.2rem 0">Registro</h3>
          <div class="grid2">
            <select id="grado">
              <option value="" selected disabled>Grado</option>
              <option>GRAL</option><option>CNL</option><option>TCNL</option><option>MY</option>
              <option>CAP</option><option>TNTE</option><option>SBTTE</option>
            </select>
            <input id="esp" placeholder="Especialidad" />
          </div>
          <div class="grid2" style="margin-top:8px">
            <input id="nom" placeholder="Nombres" />
            <input id="ape" placeholder="Apellidos" />
          </div>
          <input id="emailReg" placeholder="Email" style="margin-top:8px" />
          <input id="passReg" placeholder="Contrase√±a" type="password" style="margin-top:8px" />
          <button id="btnReg" class="btn btn-primary" style="margin-top:10px">Crear cuenta</button>
        </div>

        <div>
          <h3 style="margin:.2rem 0">Iniciar sesi√≥n</h3>
          <input id="email" placeholder="Email" />
          <input id="pass" placeholder="Contrase√±a" type="password" style="margin-top:8px" />
          <button id="btnLogin" class="btn btn-primary" style="margin-top:10px">Entrar</button>
          <p class="muted" style="margin-top:10px">Admin: <b>admin@cie297.mil</b> / <b>Admin123!</b></p>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== APP (SE MUESTRA RECI√âN TRAS LOGIN) ====== -->
  <div id="app" class="wrap">
    <div class="row">
      <div class="section card">
        <h3>√Årea Operativa</h3>
        <div id="map"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <span class="badge baja">BAJA</span>
          <span class="badge media">MEDIA</span>
          <span class="badge alta">ALTA</span>
        </div>
      </div>
      <div class="section card">
        <div class="topbar">
          <h3 style="margin:0">Alertas</h3>
          <span id="count" class="pill muted">0</span>
        </div>
        <div id="alerts" class="list"></div>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="section card">
        <h3>Misiones / Reportes r√°pidos</h3>
        <div class="grid2">
          <div>
            <label class="muted">Tipo</label>
            <select id="tipo">
              <option>Rebasado</option>
              <option>Cambio de locaci√≥n</option>
              <option>Secuestro</option>
              <option>Operativo</option>
              <option>Incautaci√≥n de autos</option>
              <option>Otros</option>
            </select>
          </div>
          <div>
            <label class="muted">Nivel</label>
            <select id="nivel">
              <option>BAJA</option><option selected>MEDIA</option><option>ALTA</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="muted">Mensaje</label>
            <select id="mensaje">
              <option>PETA</option><option>LAMBO</option><option>TRICICLO</option><option>PATINETA</option>
              <option>FRUTAS</option><option>MOTOBOMBA</option><option>CUCHARA</option><option>TENEDOR</option>
              <option>CHISGUETE</option><option>PINTURA ROJA</option><option>PINTURA NARANJA</option>
              <option>PINTURA AZUL</option><option>PINTURA VERDE</option><option>PINTURA AMARILLA</option>
              <option>PINTURA CAFE</option><option>YENAS</option><option>LOBOS</option><option>LIEBRES</option>
              <option>JUGANDO</option><option>RIO PILCOMAYO</option><option>LAGUNA ESCOBAR</option>
              <option>MALLASA</option><option>CIELO NUBLADO</option><option>HOTEL RADISSON</option>
              <option>HERRADURA</option><option>FEDERAL</option><option>CAIMAN</option><option>LAGARTOS</option>
            </select>
          </div>
          <div>
            <label class="muted">Ubicaci√≥n</label>
            <div class="grid2">
              <input id="lat" placeholder="lat" />
              <input id="lng" placeholder="lng" />
            </div>
            <button id="btnUbic" class="btn" style="margin-top:8px">Usar ubicaci√≥n</button>
          </div>
        </div>

        <label class="muted" style="margin-top:8px;display:block">Descripci√≥n</label>
        <textarea id="desc" placeholder="Detallar lo ocurrido..."></textarea>
        <div style="text-align:right;margin-top:8px">
          <button id="btnEnviar" class="btn btn-primary">Enviar</button>
        </div>
      </div>

      <div class="section card">
        <h3>√ìrganos de b√∫squeda</h3>
        <label class="muted">C√≥digo indicativo del lugar</label>
        <select id="lug">
          <option>HAWAI</option><option>CUBA</option><option>BEIRUT</option><option>LOMAS</option>
        </select>
        <label class="muted" style="margin-top:8px;display:block">C√≥digo indicativo de canales</label>
        <select id="can">
          <option>BLANCO</option><option>ROJO</option><option>AZUL</option><option>AMARILLO</option>
          <option>VERDE</option><option>ROSADO</option><option>GUINDO</option><option>CARMESI</option>
          <option>NEGRO</option><option>KAKI</option><option>MARRON</option><option>TURQUESA</option>
          <option>CELESTE</option><option>NARANJA</option><option>PURPURA</option><option>GRIS</option>
        </select>
        <label class="muted" style="margin-top:8px;display:block">C√≥digo indicativo de llamadas</label>
        <select id="llam">
          <option>ZEUS</option><option>ARIES</option><option>VIRGO</option><option>SAGITARIO</option><option>LIBRA</option>
          <option>CAPRICORNIO</option><option>GEMINIS</option><option>ESCORPIO</option><option>TAURO</option><option>CANCER</option>
          <option>LEO</option><option>PISCIS</option>
        </select>
      </div>
    </div>

    <div id="adminPanel" class="card hidden" style="margin-top:16px">
      <div class="topbar">
        <h3 style="margin:0">Administrador ‚Äì Consola</h3>
        <div style="display:flex;gap:8px">
          <button id="btnVerTodas" class="btn">Ver todas</button>
          <button id="btnPDF" class="btn btn-primary">Exportar PDF</button>
        </div>
      </div>
      <div id="tabla10" class="list"></div>
      <hr style="border-color:var(--line)"/>
      <h4 style="margin:4px 0 8px">Bit√°cora de accesos</h4>
      <div id="bitacora" class="list"></div>
    </div>
  </div>

<script>
const $ = s=>document.querySelector(s);
const el = (tag, cls, html)=>{const n=document.createElement(tag); if(cls) n.className=cls; if(html!==undefined) n.innerHTML=html; return n;}

const DB = {
  users: JSON.parse(localStorage.getItem('users')||'[]'),
  alerts: JSON.parse(localStorage.getItem('alerts')||'[]'),
  bitac: JSON.parse(localStorage.getItem('bitac')||'[]'),
  save(){ localStorage.setItem('users',JSON.stringify(this.users));
          localStorage.setItem('alerts',JSON.stringify(this.alerts));
          localStorage.setItem('bitac',JSON.stringify(this.bitac)); }
};

// seed admin
if(!DB.users.find(u=>u.email==='admin@cie297.mil')){
  DB.users.push({email:'admin@cie297.mil', pass:'Admin123!', grado:'TCNL', nom:'Administrador', ape:'CIE-297', rol:'ADMIN', blocked:false});
  DB.save();
}

let session = JSON.parse(localStorage.getItem('session')||'null');
const roles = {ADMIN:'ADMIN', USER:'USER'};
let map, markerLayer;

function setSession(user){
  session = user;
  if(user) localStorage.setItem('session',JSON.stringify(user));
  else localStorage.removeItem('session');
  renderAuthState();
}

function renderAuthState(){
  const auth = $('#auth'); const app = $('#app'); const who = $('#who'); const out=$('#logoutBtn');
  if(session){
    who.textContent = session.email+' ('+session.rol+')';
    auth.classList.add('hidden');
    out.classList.remove('hidden');
    app.style.display = 'block'; // <- mostrar app
    initAfterLogin();
  }else{
    who.textContent='';
    out.classList.add('hidden');
    app.style.display='none'; // <- OCULTAR APP COMPLETA
    $('#auth').classList.remove('hidden');
  }
}

$('#logoutBtn').onclick = ()=> setSession(null);

// Registro
$('#btnReg').onclick = ()=>{
  const u = {
    email: $('#emailReg').value.trim(),
    pass: $('#passReg').value,
    grado: $('#grado').value,
    esp: $('#esp').value,
    nom: $('#nom').value, ape: $('#ape').value,
    rol: roles.USER, blocked:false
  };
  if(!u.email || !u.pass){ alert('Completa email y contrase√±a'); return; }
  if(DB.users.find(x=>x.email===u.email)){ alert('Ya existe ese usuario'); return; }
  DB.users.push(u); DB.bitac.push({t:Date.now(), e:u.email, ev:'REGISTRO'}); DB.save();
  alert('Cuenta creada. Ahora inicia sesi√≥n.'); 
};

// Login
$('#btnLogin').onclick = ()=>{
  const email = $('#email').value.trim(), pass = $('#pass').value;
  const u = DB.users.find(x=>x.email===email && x.pass===pass);
  if(!u) return alert('Credenciales incorrectas');
  if(u.blocked) return alert('Acceso bloqueado');
  DB.bitac.push({t:Date.now(), e:u.email, ev:'LOGIN'}); DB.save();
  setSession({email:u.email, rol:u.rol, grado:u.grado, nom:u.nom, ape:u.ape});
};

function initAfterLogin(){
  // mapa solo una vez
  if(!map){
    map = L.map('map',{zoomControl:true});
    const bolivia = [-16.29,-63.59];
    map.setView(bolivia, 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markerLayer = L.layerGroup().addTo(map);
  }
  // admin panel
  $('#adminPanel').classList.toggle('hidden', session.rol!==roles.ADMIN);
  drawLists();
  startSimulator();
}

function drawLists(){
  // alertas laterales
  const cnt = $('#alerts'); cnt.innerHTML='';
  DB.alerts.slice(-30).reverse().forEach(a=> cnt.appendChild(renderAlertItem(a)));
  $('#count').textContent = DB.alerts.length;

  // top 10 admin
  if(session?.rol===roles.ADMIN){
    const box = $('#tabla10'); box.innerHTML='';
    DB.alerts.slice(-10).reverse().forEach(a=> box.appendChild(renderAlertRow(a)));
    // bit√°cora
    const b = $('#bitacora'); b.innerHTML='';
    DB.bitac.slice(-12).reverse().forEach(i=>{
      const d = new Date(i.t);
      b.appendChild(el('div','item', `<b>${i.ev}</b> ‚Äî <span class="muted">${i.e}</span><div class="muted">${d.toLocaleString()}</div>`));
    });
  }
}

function renderAlertItem(a){
  const d = new Date(a.t);
  const n = el('div','item');
  const pillClass = a.nivel==='ALTA'?'alta':(a.nivel==='MEDIA'?'media':'baja');
  n.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
      <span class="badge ${pillClass}">${a.nivel}</span>
      <span class="muted">${d.toLocaleTimeString()}</span>
    </div>
    <div style="margin-top:6px"><b>${a.titulo}</b></div>
    <div class="muted" style="margin-top:4px">${a.desc||''}</div>`;
  return n;
}

function renderAlertRow(a){
  const d=new Date(a.t);
  const pillClass = a.nivel==='ALTA'?'alta':(a.nivel==='MEDIA'?'media':'baja');
  return el('div','item',`
    <div style="display:grid;grid-template-columns:80px 130px 100px 1fr 120px;gap:10px">
      <span class="muted">${a.id.slice(-6)}</span>
      <span class="muted">${d.toLocaleString()}</span>
      <span class="badge ${pillClass}">${a.nivel}</span>
      <span>${a.titulo}</span>
      <span class="muted">${a.agente||'-'}</span>
    </div>`);
}

// Enviar reporte
$('#btnUbic').onclick = ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      $('#lat').value = pos.coords.latitude.toFixed(5);
      $('#lng').value = pos.coords.longitude.toFixed(5);
      if(map){ map.setView([pos.coords.latitude,pos.coords.longitude], 12); }
    }, ()=> alert('No se pudo obtener ubicaci√≥n'));
  }else alert('Sin geolocalizaci√≥n');
};

$('#btnEnviar').onclick = ()=>{
  if(!session){ alert('Inicia sesi√≥n'); return; }
  const a = {
    id: crypto.randomUUID(),
    t: Date.now(),
    nivel: $('#nivel').value,
    titulo: $('#tipo').value + ' ‚Äî ' + $('#mensaje').value,
    desc: `[${$('#llam').value} | ${$('#can').value} | ${$('#lug').value}] ${$('#desc').value||''}`,
    agente: $('#llam').value,
    lat: parseFloat($('#lat').value)||null,
    lng: parseFloat($('#lng').value)||null
  };
  DB.alerts.push(a); DB.save();
  // mapa
  if(a.lat && a.lng){
    L.marker([a.lat,a.lng]).addTo(markerLayer).bindPopup(a.titulo);
  }
  drawLists();
  alert('Reporte registrado');
};

// Ver todas y PDF
$('#btnVerTodas').onclick = ()=>{
  if(!session || session.rol!==roles.ADMIN) return;
  const porDia = {};
  DB.alerts.forEach(a=>{
    const d = new Date(a.t);
    const key = d.toISOString().slice(0,10);
    porDia[key] = porDia[key] || [];
    porDia[key].push(a);
  });
  let msg=''; Object.keys(porDia).sort().reverse().forEach(k=>{
    msg+= `\nüìÖ ${k}\n` + porDia[k].map(x=>`- ${new Date(x.t).toLocaleTimeString()} ${x.nivel} ${x.titulo} (${x.agente})`).join('\n');
  });
  alert(msg || 'Sin alertas');
};

$('#btnPDF').onclick = ()=>{
  if(!session || session.rol!==roles.ADMIN) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text('CIE-297 ‚Äì Reporte de Alertas', 14, 14);
  doc.setFontSize(9);
  doc.text(new Date().toLocaleString(), 14, 20);

  // Tabla simple
  const startY = 28;
  let y = startY;
  doc.setFont(undefined,'bold');
  doc.text('ID',14,y); doc.text('Fecha y Hora',34,y); doc.text('Nivel',84,y); doc.text('T√≠tulo',110,y); doc.text('Agente',180,y);
  doc.setFont(undefined,'normal'); y+=6;

  DB.alerts.slice(-30).forEach(a=>{
    const row = [a.id.slice(-6), new Date(a.t).toLocaleString(), a.nivel, a.titulo, a.agente||'-'];
    doc.text(row[0],14,y); doc.text(row[1],34,y); doc.text(row[2],84,y); doc.text(row[3].slice(0,50),110,y); doc.text(row[4],180,y);
    y+=6;
    if(y>280){ doc.addPage(); y=14; }
  });

  doc.save('reporte_alertas.pdf');
};

// Simulador de alertas (5s)
let simTimer=null;
function startSimulator(){
  if(simTimer) return;
  const niveles=['BAJA','MEDIA','ALTA'];
  const agentes=['ZEUS','ARIES','VIRGO','SAGITARIO','LIBRA','CAPRICORNIO','GEMINIS','ESCORPIO','TAURO','CANCER','LEO','PISCIS'];
  const titulos=['Actualizaci√≥n de posici√≥n','Interferencia RF','Geocerca violada','Movimiento an√≥malo','P√©rdida de comunicaci√≥n','Operativo en curso','Incidente observado'];
  simTimer = setInterval(()=>{
    const a={
      id: crypto.randomUUID(),
      t: Date.now(),
      nivel: niveles[Math.floor(Math.random()*niveles.length)],
      titulo: titulos[Math.floor(Math.random()*titulos.length)],
      agente: agentes[Math.floor(Math.random()*agentes.length)]
    };
    DB.alerts.push(a); DB.save(); drawLists();
  },5000);
}

// iniciar estado
renderAuthState();
</script>
</body>
</html>
