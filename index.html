<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CIE-297 | Monitoreo en Tiempo Real</title>
  <link rel="icon" href="assets/logo.png"/>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --bg:#0b1424;--panel:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.08);
      --brand:#98b7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    a{color:#8ab4ff;text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    header{display:flex;gap:.75rem;align-items:center;position:sticky;top:0;background:#0b1424;z-index:2;border-bottom:1px solid var(--line);padding:.75rem 1rem}
    header img{width:36px;height:36px;border-radius:50%;object-fit:contain;background:#0b1424}
    header h1{font-size:18px;margin:0;font-weight:800}
    .tag{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--line);padding:.25rem .6rem;border-radius:999px;font-weight:700;letter-spacing:.3px}
    .tag.ok{border-color:var(--ok);color:var(--ok)}
    .tag.warn{border-color:var(--warn);color:var(--warn)}
    .tag.danger{border-color:var(--danger);color:var(--danger)}
    .grid{display:grid;gap:16px;grid-template-columns:2fr 1.2fr}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    h2{margin:.25rem 0 12px 0}
    .legend{display:flex;gap:10px;margin-top:10px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:.35rem .65rem;border-radius:999px;border:1px solid var(--line);font-weight:700}
    .chip i{display:inline-block;width:8px;height:8px;border-radius:50%}
    .chip.low i{background:var(--ok)} .chip.med i{background:var(--warn)} .chip.high i{background:var(--danger)}
    #map{height:440px;border:1px dashed #2b3a55;border-radius:10px;background:#0f1a2b;display:flex;align-items:center;justify-content:center;color:#6d7ca1}
    .row{display:flex;gap:10px;align-items:center}
    select, input[type=text], input[type=email], input[type=password], textarea{
      background:#0f1b30;border:1px solid var(--line);color:var(--text);padding:.7rem .8rem;border-radius:8px;outline:none;width:100%;
    }
    textarea{min-height:120px;resize:vertical}
    .btn{background:#192642;border:1px solid var(--line);color:var(--text);padding:.6rem .9rem;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:#243a73;border-color:#3250a8}
    .btn.ghost{background:#0f1b30}
    .btn.small{padding:.45rem .7rem}
    .stack{display:flex;flex-direction:column;gap:8px}
    .feed{display:flex;flex-direction:column;gap:10px;max-height:480px;overflow:auto;padding-right:6px}
    .item{background:#0f1b30;border:1px solid var(--line);border-radius:12px;padding:.55rem .8rem}
    .item .top{display:flex;align-items:center;gap:8px}
    .badge{padding:.2rem .6rem;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .badge.low{background:rgba(34,197,94,.15);border-color:#276749;color:#22c55e}
    .badge.med{background:rgba(245,158,11,.15);border-color:#8a5a0a;color:#f59e0b}
    .badge.high{background:rgba(239,68,68,.15);border-color:#7f1d1d;color:#ef4444}
    .muted{color:var(--muted)}
    .right{display:flex;justify-content:flex-end}
    /* Login modal */
    #gate{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:5}
    #gate .panel{width:min(980px,100%);background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px}
    #gate h3{margin:0 0 12px 0}
    .two{display:grid;gap:14px;grid-template-columns:1.2fr 1fr}
    .foot{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
    /* Admin board */
    .admin-only{display:none}
    footer{margin:18px 0;color:#8aa2d3;text-align:center;font-size:12px}
    @media (max-width:1020px){ .grid{grid-template-columns:1fr} .two{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <img src="assets/logo.png" alt="logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 80%22><rect width=%2280%22 height=%2280%22 rx=%2210%22 fill=%230b1424%22/><text x=%2240%22 y=%2246%22 text-anchor=%22middle%22 font-size=%2222%22 fill=%2398b7ff%22 font-family=%22Arial%22>L</text></svg>'"/>
  <h1>CIE‑297 | Monitoreo en Tiempo Real</h1>
  <div style="margin-left:auto" class="row">
    <button id="btnLoginTop" class="btn small">Iniciar sesión</button>
    <button id="btnLogout" class="btn small ghost" style="display:none">Cerrar sesión</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Área Operativa</h2>
      <div id="map">Mapa aquí (tu implementación existente)</div>
      <div class="legend">
        <span class="chip low"><i></i>BAJA</span>
        <span class="chip med"><i></i>MEDIA</span>
        <span class="chip high"><i></i>ALTA</span>
      </div>

      <div class="card" style="margin-top:14px">
        <h3>Misiones / Reportes rápidos</h3>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div style="min-width:210px;flex:1">
            <label>Tipo</label>
            <select id="rTipo">
              <option>Operativo en zona</option>
              <option>Incautación de autos</option>
              <option>Rebasado</option>
              <option>Incidente</option>
            </select>
          </div>
          <div style="min-width:180px">
            <label>Nivel</label>
            <select id="rNivel">
              <option>BAJA</option>
              <option>MEDIA</option>
              <option>ALTA</option>
            </select>
          </div>
          <div style="min-width:220px;flex:1">
            <label>Mensaje</label>
            <select id="rMensaje">
              <option>PETA</option><option>LAMBO</option><option>TRICICLO</option><option>PATINETA</option>
              <option>FRUTAS</option><option>MOTOBOMBA</option><option>CUCHARA</option><option>TENEDOR</option>
              <option>CHISGUETE</option><option>PINTURA ROJA</option><option>PINTURA NARANJA</option>
              <option>PINTURA AZUL</option><option>PINTURA VERDE</option><option>PINTURA AMARILLA</option>
              <option>PINTURA CAFE</option><option>YENAS</option><option>LOBOS</option><option>LIEBRES</option>
              <option>JUGANDO</option><option>RIO PILCOMAYO</option><option>LAGUNA ESCOBAR</option>
              <option>MALLASA</option><option>CIELO NUBLADO</option><option>HOTEL RADISSON</option>
              <option>HERRADURA</option><option>FEDERAL</option><option>CAIMAN</option><option>LAGARTOS</option>
            </select>
          </div>
          <div style="min-width:150px">
            <label>Lat</label>
            <input id="rLat" type="text" placeholder="lat"/>
          </div>
          <div style="min-width:150px">
            <label>Lng</label>
            <input id="rLng" type="text" placeholder="lng"/>
          </div>
          <div>
            <label>&nbsp;</label><br/>
            <button id="btnGeo" class="btn small">Usar ubicación</button>
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <label>Descripción</label>
          <textarea id="rDesc" placeholder="Detallar lo ocurrido..."></textarea>
          <div class="right"><button id="btnEnviar" class="btn primary">Enviar</button></div>
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>Órganos de búsqueda</h2>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <div class="stack" style="min-width:160px">
          <label>Código indicativo del lugar</label>
          <select id="selLugar">
            <option>HAWAI</option><option>CUBA</option><option>BEIRUT</option><option>LOMAS</option>
          </select>
        </div>
        <div class="stack" style="min-width:180px">
          <label>Código indicativo de canales</label>
          <select id="selCanal">
            <option>BLANCO</option><option>ROJO</option><option>AZUL</option><option>AMARILLO</option>
            <option>VERDE</option><option>ROSADO</option><option>GUINDO</option><option>CARMEESI</option>
            <option>NEGRO</option><option>KAKI</option><option>MARRON</option><option>TURQUESA</option>
            <option>CELESTE</option><option>NARANJA</option><option>PURPURA</option><option>GRIS</option>
          </select>
        </div>
        <div class="stack" style="min-width:180px">
          <label>Código indicativo de llamadas</label>
          <select id="selLlamada">
            <option>ZEUS</option><option>ARIES</option><option>VIRGO</option><option>SAGITARIO</option>
            <option>LIBRA</option><option>CAPRICORNIO</option><option>GEMINIS</option><option>ESCORPIO</option>
            <option>TAURO</option><option>CANCER</option><option>LEO</option><option>PISCIS</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin-bottom:8px">Alertas <span class="muted" id="count">(0)</span></h3>
        <div id="feed" class="feed"></div>
        <div class="admin-only" style="margin-top:10px;display:none">
          <div class="row" style="gap:8px">
            <button id="btnVerTodas" class="btn ghost" style="flex:1">Ver todas</button>
            <button id="btnPDF" class="btn" style="flex:1">Exportar PDF</button>
            <button id="btnAccesos" class="btn ghost" style="flex:1">Accesos</button>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="card admin-only" id="adminTabla" style="margin-top:14px;display:none">
    <h3>Alertas (10 más recientes)</h3>
    <div style="overflow:auto">
      <table id="tbl10" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>Fecha</th><th>Nivel</th><th>Título</th><th>Agente</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <footer>© CIE‑297 — Prototipo académico</footer>
</div>

<!-- PUERTA DE ACCESO -->
<div id="gate">
  <div class="panel">
    <h3>Acceso</h3>
    <div class="two">
      <div>
        <h4>Registro</h4>
        <div class="stack">
          <label>Grado</label>
          <select id="grd">
            <option>SLDO</option><option>SGT</option><option>SOF</option><option>SBTTE</option>
            <option>TTE</option><option>CAP</option><option>MY</option><option>TCNL</option>
            <option>CNL</option><option>GRAL</option>
          </select>
          <label>Especialidad</label><input id="esp" type="text" placeholder="Especialidad"/>
          <label>Nombres</label><input id="nom" type="text" placeholder="Nombres"/>
          <label>Apellidos</label><input id="ape" type="text" placeholder="Apellidos"/>
          <label>Email</label><input id="cor" type="email" placeholder="email@cie297.mil"/>
          <label>Contraseña</label><input id="cla" type="password" placeholder="••••••"/>
          <div class="right"><button id="btnReg" class="btn">Crear cuenta</button></div>
        </div>
      </div>
      <div>
        <h4>Iniciar sesión</h4>
        <div class="stack">
          <label>Email</label><input id="lgUser" type="email" placeholder="email@cie297.mil"/>
          <label>Contraseña</label><input id="lgPass" type="password" placeholder="••••••"/>
          <div class="foot">
            <button id="btnDoLogin" class="btn primary">Entrar</button>
            <button id="btnCloseGate" class="btn ghost">Cerrar</button>
          </div>
          <small class="muted">Primero inicia sesión o crea una cuenta. El contenido del sistema se mostrará después.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = q=>document.querySelector(q);
const $$ = q=>document.querySelectorAll(q);

const ADMIN_EMAIL = 'admin@cie297.mil';
const ADMIN_PASS  = 'Admin123!';
const STORAGE_USERS = 'cie297_users';
const STORAGE_ALERTS = 'cie297_alerts';
const STORAGE_ACCESS = 'cie297_access';

const state = {
  me:null,
  alerts: loadJson(STORAGE_ALERTS, [])
};

function loadJson(k, def){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); }catch(e){ return def; } }
function saveJson(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

function fmtDate(ts){
  const d=new Date(ts);
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  const ss=String(d.getSeconds()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

function byId(id){ return document.getElementById(id); }

/* ---------- Mapa Leaflet ---------- */
let map, markerSelf;
function initMap(){
  map = L.map('map').setView([-16.5,-68.15], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
}
function useGeo(){
  if(!navigator.geolocation) return alert('Geo no disponible');
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    byId('rLat').value = latitude.toFixed(6);
    byId('rLng').value = longitude.toFixed(6);
    if(markerSelf) map.removeLayer(markerSelf);
    markerSelf = L.marker([latitude, longitude]).addTo(map);
    map.setView([latitude, longitude], 12);
  }, _=> alert('No se pudo obtener ubicación'));
}

/* ---------- Sesión ---------- */
function openGate(){ byId('gate').style.display='flex'; }
function closeGate(){ byId('gate').style.display='none'; }

function login(email, pass){
  // Admin directo
  if(email===ADMIN_EMAIL && pass===ADMIN_PASS){
    state.me = {email, admin:true, nombres:'ADMIN', apellidos:''};
  }else{
    const users = loadJson(STORAGE_USERS, []);
    const u = users.find(x=>x.email===email && x.pass===pass);
    if(!u) return false;
    state.me = {email:u.email, nombres:u.nombres, apellidos:u.apellidos, admin:false};
  }
  // Accesos
  const acc = loadJson(STORAGE_ACCESS, []);
  acc.push({email: state.me.email, ts: Date.now()});
  saveJson(STORAGE_ACCESS, acc);
  // UI
  afterLogin();
  return true;
}

function afterLogin(){
  closeGate();
  $("#btnLoginTop").style.display='none';
  $("#btnLogout").style.display='inline-flex';
  const isAdm = !!state.me.admin;
  $$(".admin-only").forEach(el=> el.style.display = isAdm ? '' : 'none');
}

function logout(){
  state.me=null;
  $("#btnLoginTop").style.display='inline-flex';
  $("#btnLogout").style.display='none';
  $$(".admin-only").forEach(el=> el.style.display='none');
  openGate();
}

/* ---------- Registro ---------- */
function register(){
  const user = {
    grado: byId('grd').value,
    esp: byId('esp').value,
    nombres: byId('nom').value,
    apellidos: byId('ape').value,
    email: byId('cor').value,
    pass: byId('cla').value
  };
  if(!(user.email && user.pass)) return alert('Completa email y contraseña');
  const users = loadJson(STORAGE_USERS, []);
  if(users.some(u=>u.email===user.email)) return alert('Ya existe');
  users.push(user); saveJson(STORAGE_USERS, users);
  alert('Cuenta creada. Ahora inicia sesión.');
}

/* ---------- Alertas (simulador + feed) ---------- */
const LLAMADAS = ['ZEUS','ARIES','VIRGO','SAGITARIO','LIBRA','CAPRICORNIO','GEMINIS','ESCORPIO','TAURO','CANCER','LEO','PISCIS'];
const TITULOS = ['ACTUALIZACIÓN DE POSICIÓN','INTERFERENCIA RF','GEOCERCA VIOLADA','MOVIMIENTO ANÓMALO','INCIDENTE','OBSERVACIÓN'];
const NIVELES = ['BAJA','MEDIA','ALTA'];

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randCoord(){ // dentro aprox de Bolivia
  const lat = -22 + Math.random()*7; // -22 a -15
  const lng = -69 + Math.random()*8; // -69 a -61
  return [lat.toFixed(4), lng.toFixed(4)];
}

function pushAlert(a){
  state.alerts.push(a);
  if(state.alerts.length>500) state.alerts.shift();
  saveJson(STORAGE_ALERTS, state.alerts);
  renderFeed(); renderAdmin10();
}

function simulateAlert(){
  const [lat,lng] = randCoord();
  pushAlert({
    id: Math.random().toString(16).slice(2,8),
    ts: Date.now(),
    nivel: rand(NIVELES),
    titulo: rand(TITULOS),
    agente: rand(LLAMADAS),
    lat, lng
  });
}

let simTimer;
function startSim(){ stopSim(); simTimer=setInterval(simulateAlert, 5000); }
function stopSim(){ if(simTimer) clearInterval(simTimer); }

function badgeCls(n){ return n==='ALTA'?'high':(n==='MEDIA'?'med':'low'); }

function renderFeed(){
  const feed = byId('feed');
  feed.innerHTML='';
  const last = [...state.alerts].slice(-50).reverse();
  byId('count').textContent = '('+state.alerts.length+')';
  last.forEach(a=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML = `
      <div class="top">
        <span class="badge ${badgeCls(a.nivel)}">${a.nivel}</span>
        <span class="muted">${fmtDate(a.ts)}</span>
        <span style="margin-left:auto" class="muted">${a.agente}</span>
      </div>
      <div style="margin-top:6px;font-weight:700">${a.titulo}</div>
      <div class="muted" style="margin-top:2px">(${a.lat}, ${a.lng})</div>
    `;
    feed.appendChild(div);
  });
}

function renderAdmin10(){
  const tb = byId('tbl10').querySelector('tbody');
  if(!tb) return;
  tb.innerHTML='';
  const last=[...state.alerts].slice(-10).reverse();
  last.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${a.id}</td><td>${fmtDate(a.ts)}</td><td>${a.nivel}</td><td>${a.titulo}</td><td>${a.agente}</td>`;
    tb.appendChild(tr);
  });
}

/* ---------- Reporte manual ---------- */
function sendReport(){
  const lat = byId('rLat').value || randCoord()[0];
  const lng = byId('rLng').value || randCoord()[1];
  const a = {
    id: Math.random().toString(16).slice(2,8),
    ts: Date.now(),
    nivel: byId('rNivel').value,
    titulo: byId('rMensaje').value,
    agente: byId('selLlamada').value,
    lat, lng,
    desc: byId('rDesc').value || byId('rTipo').value
  };
  pushAlert(a);
  alert('Enviado');
}

/* ---------- Admin: Ver todas / PDF / Accesos ---------- */
function verTodas(){
  const porDia={};
  state.alerts.forEach(a=>{
    const d = new Date(a.ts).toISOString().slice(0,10);
    (porDia[d]||(porDia[d]=[])).push(a);
  });
  const w = window.open('','_blank');
  w.document.write('<html><head><title>Alertas por día</title><style>body{font-family:Arial;background:#0b1424;color:#e5ecff} table{border-collapse:collapse;width:100%} th,td{border:1px solid #2b3a55;padding:6px}</style></head><body>');
  w.document.write('<h2>Alertas por día</h2>');
  Object.keys(porDia).sort().reverse().forEach(d=>{
    w.document.write('<h3>'+d+'</h3><table><tr><th>ID</th><th>Fecha y hora</th><th>Nivel</th><th>Título</th><th>Agente</th></tr>');
    porDia[d].sort((a,b)=>b.ts-a.ts).forEach(a=>{
      w.document.write(`<tr><td>${a.id}</td><td>${fmtDate(a.ts)}</td><td>${a.nivel}</td><td>${a.titulo}</td><td>${a.agente}</td></tr>`);
    });
    w.document.write('</table>');
  });
  w.document.write('</body></html>');
  w.document.close();
}

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  // Logo si existe
  try{
    const img = await fetch('assets/logo.png').then(r=>r.blob()).then(b=>new Promise(res=>{const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(b);}));
    doc.addImage(img,'PNG',10,6,18,18);
  }catch(e){}
  doc.setFontSize(14);
  doc.text('CIE-297 – Reporte de Alertas', 32, 16);
  doc.setFontSize(10);
  doc.text(new Date().toLocaleString(), 32, 22);

  const rows = [...state.alerts].slice(-50).reverse().map(a=>[a.id, fmtDate(a.ts), a.nivel, a.titulo, a.agente]);
  doc.autoTable({
    head:[['ID','Fecha y hora','Nivel','Título','Agente']],
    body: rows,
    startY: 28,
    styles:{fontSize:9}
  });
  doc.save('reporte_alertas.pdf');
}

function verAccesos(){
  const acc = loadJson(STORAGE_ACCESS, []);
  const w = window.open('','_blank');
  w.document.write('<html><head><title>Accesos</title><style>body{font-family:Arial;background:#0b1424;color:#e5ecff} table{border-collapse:collapse;width:100%} th,td{border:1px solid #2b3a55;padding:6px}</style></head><body>');
  w.document.write('<h2>Accesos</h2><table><tr><th>Email</th><th>Fecha y hora</th></tr>');
  acc.slice().reverse().forEach(x=> w.document.write(`<tr><td>${x.email}</td><td>${fmtDate(x.ts)}</td></tr>`));
  w.document.write('</table></body></html>');
  w.document.close();
}

/* ---------- Eventos UI ---------- */
byId('btnLoginTop').onclick = openGate;
byId('btnCloseGate').onclick = closeGate;
byId('btnDoLogin').onclick = ()=>{
  const e=byId('lgUser').value, p=byId('lgPass').value;
  if(!login(e,p)) alert('Error login HTTP 404');
};
byId('btnLogout').onclick = logout;
byId('btnReg').onclick = register;
byId('btnGeo').onclick = useGeo;
byId('btnEnviar').onclick = sendReport;
byId('btnVerTodas').onclick = verTodas;
byId('btnPDF').onclick = exportPDF;
byId('btnAccesos').onclick = verAccesos;

/* ---------- Init ---------- */
initMap();
renderFeed(); renderAdmin10();
startSim();
openGate();
</script>
</body>
</html>
