<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CIE-297 | Monitoreo en Tiempo Real</title>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#0b1424;--card:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.06)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    a{color:#8ab4ff;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .appbar{display:flex;gap:.75rem;justify-content:space-between;padding:.75rem 1rem;background:#0b1424;position:sticky;top:0;z-index:40;border-bottom:1px solid var(--line)}
    .brand{display:flex;gap:.75rem;align-items:center;font-weight:800;font-size:18px}
    .brand img{height:32px;width:32px;object-fit:contain;border-radius:8px}
    .actions{display:flex;gap:.5rem;align-items:center}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:999px;border:1px solid var(--line);color:var(--text);background:transparent}
    .btn:hover{filter:brightness(1.08)}
    .btn-primary{background:#182240;border-color:#4f6b6b;color:#e9f9a9}
    .btn-danger{background:#182120;border-color:#ff6b6b;color:#ff9aa9}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){ .grid{grid-template-columns:2fr 1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;align-items:center}
    .control{width:100%;background:#0b1430;border:1px solid var(--line);border-radius:10px;padding:.65rem;color:var(--text);}
    .control:focus{outline:1px solid #66a3ff}
    .legend{display:flex;gap:.5rem;margin:.4rem 0 .6rem}
    .chip{display:inline-block;padding:.35rem .7rem;border-radius:999px;border:1px solid var(--line);font-weight:700;letter-spacing:.25px}
    .chip--ok{color:var(--ok);border-color:var(--ok)}
    .chip--warn{color:var(--warn);border-color:var(--warn)}
    .chip--danger{color:var(--danger);border-color:var(--danger)}
    .map{height:360px;border:1px dashed rgba(255,255,255,.15);border-radius:10px}
    .rightcol{display:flex;flex-direction:column;gap:12px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
    .item{border:1px solid var(--line);background:#0e1a30;border-radius:12px;padding:.7rem .9rem}
    .item h4{margin:0 0 .35rem 0}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0 .8rem}
    .pill{padding:.25rem .6rem;border-radius:999px;background:#15233f;font-weight:700}
    .hidden{display:none !important}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;padding:16px;z-index:100}
    .modal .box{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px;min-width:min(560px,95vw)}
    .split{display:grid;gap:12px}
    @media(min-width:860px){ .split{grid-template-columns:1fr 1fr} }
    .hdr{font-weight:800;margin:.2rem 0 .7rem}
    small.hint{color:#93a4c7;display:block;margin-top:.35rem}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">
      <img src="assets/logo.png" alt="CIE-297"/>
      CIE-297 | Monitoreo en Tiempo Real
    </div>
    <div class="actions">
      <button id="btnAdminToggle" class="btn">Usuario</button>
      <button id="btnOpenLogin" class="btn btn-primary">Iniciar sesión</button>
      <button id="btnLogout" class="btn btn-danger hidden">Cerrar sesión</button>
    </div>
  </header>

  <div class="container grid">
    <!-- izquierda -->
    <div class="left">
      <div class="card">
        <h3>Área Operativa</h3>
        <div id="map" class="map"></div>
        <div class="legend">
          <span class="chip chip--ok">BAJA</span>
          <span class="chip chip--warn">MEDIA</span>
          <span class="chip chip--danger">ALTA</span>
        </div>
      </div>

      <div class="card">
        <h3>Misiones / Reportes rápidos</h3>
        <div class="row">
          <div class="control-wrap" style="flex:1">
            <label>Tipo</label>
            <select id="repTipo" class="control">
              <option>Operativo en zona</option>
              <option>Incautación de autos</option>
              <option>Rebasado</option>
              <option>Observación</option>
              <option>Interferencia RF</option>
              <option>Movimiento anómalo</option>
            </select>
          </div>
          <div class="control-wrap" style="width:220px">
            <label>Nivel</label>
            <select id="repNivel" class="control">
              <option>BAJA</option>
              <option>MEDIA</option>
              <option>ALTA</option>
            </select>
          </div>
          <div class="control-wrap" style="width:200px">
            <label>Usar ubicación</label>
            <button id="btnLoc" class="btn">Usar ubicación</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="control-wrap" style="flex:1">
            <label>Mensaje</label>
            <select id="repMsg" class="control">
              <option>PETA</option><option>LAMBO</option><option>TRICICLO</option><option>PATINETA</option>
              <option>FRUTAS</option><option>MOTOBOMBA</option><option>CUCHARA</option><option>TENEDOR</option>
              <option>CHISGUETE</option><option>PINTURA ROJA</option><option>PINTURA NARANJA</option><option>PINTURA AZUL</option>
              <option>PINTURA VERDE</option><option>PINTURA AMARILLA</option><option>PINTURA CAFE</option><option>YENAS</option>
              <option>LOBOS</option><option>LIEBRES</option><option>JUGANDO</option><option>RIO PILCOMAYO</option>
              <option>LAGUNA ESCOBAR</option><option>MALLASA</option><option>CIELO NUBLADO</option><option>HOTEL RADISSON</option>
              <option>HERRADURA</option><option>FEDERAL</option><option>CAIMAN</option><option>LAGARTOS</option>
            </select>
          </div>
          <input id="repLat" class="control" style="width:160px" placeholder="lat"/>
          <input id="repLng" class="control" style="width:160px" placeholder="lng"/>
        </div>
        <textarea id="repDesc" class="control" rows="4" placeholder="Descripción — Detallar lo ocurrido…" style="margin-top:10px"></textarea>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="btnEnviar" class="btn btn-primary">Enviar</button>
        </div>
      </div>
    </div>

    <!-- derecha -->
    <div class="rightcol">
      <div class="card">
        <div class="topbar">
          <h3 style="margin:0">Órganos de búsqueda</h3>
          <span id="orgCount" class="pill">0 activos</span>
        </div>
        <div class="row" style="gap:12px;margin-bottom:8px">
          <div style="flex:1">
            <label>Código indicativo del lugar</label>
            <select id="orgLugar" class="control">
              <option>HAWAI</option><option>CUBA</option><option>BEIRUT</option><option>LOMAS</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Código indicativo de canales</label>
            <select id="orgCanal" class="control">
              <option>BLANCO</option><option>ROJO</option><option>AZUL</option><option>AMARILLO</option><option>VERDE</option>
              <option>ROSADO</option><option>GUINDO</option><option>CARMEESI</option><option>NEGRO</option><option>KAKI</option>
              <option>MARRON</option><option>TURQUESA</option><option>CELESTE</option><option>NARANJA</option><option>PURPURA</option><option>GRIS</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Código indicativo de llamadas</label>
            <select id="orgLlamada" class="control">
              <option>ZEUS</option><option>ARIES</option><option>VIRGO</option><option>SAGITARIO</option><option>LIBRA</option>
              <option>CAPRICORNIO</option><option>GEMINIS</option><option>ESCORPIO</option><option>TAURO</option><option>CANCER</option>
              <option>LEO</option><option>PISCIS</option>
            </select>
          </div>
        </div>

        <div id="alertList" class="list"></div>
      </div>

      <div id="adminPanel" class="card hidden">
        <div class="topbar">
          <h3 style="margin:0">Alertas</h3>
          <span id="badgeQty" class="pill">0</span>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnVerTodas" class="btn">Ver todas</button>
          <button id="btnExport" class="btn">Exportar PDF</button>
          <button id="btnAccesos" class="btn">Accesos</button>
        </div>
        <div style="margin-top:10px">
          <table id="tabla10">
            <thead><tr><th>ID</th><th>Fecha</th><th>Nivel</th><th>Título</th><th>Agente</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- modal login / registro -->
  <div id="dlg" class="modal">
    <div class="box">
      <div class="split">
        <div>
          <div class="hdr">Registro</div>
          <div class="row">
            <select id="regGrado" class="control">
              <option>SLDO</option><option>SGT</option><option>SOF</option><option>SBTTE</option>
              <option>TTE</option><option>CAP</option><option>MY</option><option>TCNL</option>
              <option>CNL</option><option>GRAL</option>
            </select>
            <input id="regEsp" class="control" placeholder="Especialidad"/>
          </div>
          <div class="row">
            <input id="regNombres" class="control" placeholder="Nombres"/>
            <input id="regApellidos" class="control" placeholder="Apellidos"/>
          </div>
          <input id="regEmail" class="control" placeholder="Email"/>
          <input id="regPass" class="control" placeholder="Contraseña" type="password"/>
          <button id="btnCrear" class="btn">Crear cuenta</button>
        </div>
        <div>
          <div class="hdr">Iniciar sesión</div>
          <input id="inEmail" class="control" placeholder="Email"/>
          <input id="inPass" class="control" placeholder="Contraseña" type="password"/>
          <div class="row" style="justify-content:flex-end">
            <button id="btnEntrar" class="btn btn-primary">Entrar</button>
            <button id="btnCerrarDlg" class="btn">Cerrar</button>
          </div>
          <small class="hint">Primero inicia sesión o crea una cuenta. El contenido del sistema se mostrará después.</small>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- util / storage
    const store = {
      get: (k,def) => JSON.parse(localStorage.getItem(k)??JSON.stringify(def)),
      set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
    };
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const state = {
      admin:false,
      me:null,
      alerts:[],
      accesses: store.get('cie297.accesses', [])
    };

    // --- mapa Bolivia
    let map, marker;
    function initMap(){
      map = L.map('map', {zoomControl:true}).setView([-16.5,-68.15], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap'
      }).addTo(map);
    }

    // --- UI helpers
    function toast(msg){ alert(msg); }
    function fmtDate(ts){
      const d = new Date(ts);
      const pad = n=> String(n).padStart(2,'0');
      const date = \`\${d.getFullYear()}-\${pad(d.getMonth()+1)}-\${pad(d.getDate())}\`;
      const time = \`\${pad(d.getHours())}:\${pad(d.getMinutes())}:\${pad(d.getSeconds())}\`;
      return \`\${date} \${time}\`;
    }

    // --- login dialog
    const dlg = $('#dlg');
    $('#btnOpenLogin').onclick = ()=> dlg.style.display='grid';
    $('#btnCerrarDlg').onclick = ()=> dlg.style.display='none';

    $('#btnCrear').onclick = ()=>{
      const u = {
        grado: $('#regGrado').value,
        especialidad: $('#regEsp').value,
        nombres: $('#regNombres').value,
        apellidos: $('#regApellidos').value,
        email: $('#regEmail').value.trim(),
        pass: $('#regPass').value.trim(),
        admin:false,
        created: Date.now()
      };
      if(!u.email || !u.pass) return toast('Completa email y contraseña');
      const users = store.get('cie297.users', []);
      if(users.some(x=>x.email===u.email)) return toast('El email ya existe');
      users.push(u); store.set('cie297.users', users);
      toast('Cuenta creada. Ahora inicia sesión.');
    };

    $('#btnEntrar').onclick = ()=>{
      const email = $('#inEmail').value.trim();
      const pass = $('#inPass').value.trim();
      const users = store.get('cie297.users', []);
      // admin fijo
      let me = null;
      if(email==='admin@cie297.mil' && pass==='Admin123!'){
        me = { email, nombres:'TCNL Administrador', admin:true };
      }else{
        me = users.find(u=>u.email===email && u.pass===pass);
      }
      if(!me){ toast('Error login: credenciales'); return; }
      state.me = me; state.admin = !!me.admin;
      $('#btnLogout').classList.remove('hidden');
      $('#btnOpenLogin').classList.add('hidden');
      $('#adminPanel').classList.toggle('hidden', !state.admin);
      $('#btnAdminToggle').textContent = state.admin?'Admin':'Usuario';
      dlg.style.display='none';
      // registra acceso
      state.accesses.push({email: me.email, at: Date.now(), blocked:false});
      store.set('cie297.accesses', state.accesses);
      render();
    };

    $('#btnLogout').onclick = ()=>{
      state.me=null; state.admin=false;
      $('#btnLogout').classList.add('hidden');
      $('#btnOpenLogin').classList.remove('hidden');
      $('#adminPanel').classList.add('hidden');
      $('#btnAdminToggle').textContent = 'Usuario';
      render();
    };

    // --- órganos no persistentes, solo efecto
    function rand(a){ return a[Math.floor(Math.random()*a.length)] }
    function addFakeAlert(){
      const niveles=['BAJA','MEDIA','ALTA'];
      const tipos=['OBSERVACIÓN','INTERFERENCIA RF','MOVIMIENTO ANÓMALO','REBASE','INCIDENTE','PATRULLA','RELEVO'];
      const agentes=['ZEUS','ARIES','VIRGO','SAGITARIO','LIBRA','CAPRICORNIO','GEMINIS','ESCORPIO','TAURO','CANCER','LEO','PISCIS'];
      const a={
        id: Math.random().toString(16).slice(2,8),
        ts: Date.now(),
        nivel: rand(niveles),
        tipo: 'SIMULADO',
        titulo: rand(tipos),
        agente: rand(agentes),
        lat: (-16 + Math.random()).toFixed(4),
        lng: (-68 + Math.random()).toFixed(4)
      };
      state.alerts.unshift(a);
      state.alerts = state.alerts.slice(0,200);
      render();
    }

    // --- render alertas
    function renderAlertList(){
      const list = $('#alertList');
      list.innerHTML = state.alerts.slice(0,50).map(a=>{
        const badgeCls = a.nivel==='ALTA'?'chip--danger':(a.nivel==='MEDIA'?'chip--warn':'chip--ok');
        return \`<div class="item">
          <div class="row" style="justify-content:space-between">
            <div class="row" style="gap:.5rem;align-items:center">
              <span class="chip \${badgeCls}">\${a.nivel}</span>
              <strong>\${fmtDate(a.ts)}</strong>
            </div>
            <span class="pill">SIMULADO</span>
          </div>
          <div> <strong>\${a.agente}</strong> — \${a.titulo} <span class="muted">( \${a.lat}, \${a.lng} )</span></div>
        </div>\`;
      }).join('');
      $('#badgeQty').textContent = state.alerts.length;
      // tabla 10
      const tbody = $('#tabla10 tbody');
      tbody.innerHTML = state.alerts.slice(0,10).map(a=>\`
        <tr><td>\${a.id}</td><td>\${fmtDate(a.ts)}</td><td>\${a.nivel}</td><td>\${a.titulo}</td><td>\${a.agente}</td></tr>\`
      ).join('');
    }

    // --- export PDF (simple HTML + print)
    $('#btnExport').onclick = ()=>{
      const now = new Date();
      const rows = state.alerts.slice(0,50).map(a=>\`
        <tr><td>\${a.id}</td><td>\${fmtDate(a.ts)}</td><td>\${a.nivel}</td><td>\${a.titulo}</td><td>\${a.agente}</td></tr>\`).join('');
      const html = \`
      <html><head><meta charset='utf-8'><title>Reporte de Alertas</title>
      <style>
        body{font:12px Arial;padding:24px}
        table{border-collapse:collapse;width:100%}
        th,td{border:1px solid #c7d2fe;padding:6px;text-align:left}
        thead{background:#1e60a1;color:#fff}
        .hdr{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .hdr img{height:44px}
      </style></head>
      <body>
        <div class="hdr">
          <img src="assets/logo.png"/><div>
            <div style="font-weight:800;font-size:18px">CIE-297 – Reporte de Alertas</div>
            <div>\${fmtDate(Date.now())}</div>
          </div>
        </div>
        <table>
          <thead><tr><th>ID</th><th>Fecha y hora</th><th>Nivel</th><th>Título</th><th>Agente</th></tr></thead>
          <tbody>\${rows}</tbody>
        </table>
      </body></html>\`;
      const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.focus(); w.print();
    };

    // --- Ver todas (agrupadas por día)
    $('#btnVerTodas').onclick = ()=>{
      const porDia = {};
      state.alerts.forEach(a=>{
        const d = new Date(a.ts).toISOString().slice(0,10);
        (porDia[d]||(porDia[d]=[])).push(a);
      });
      const w = window.open('','_blank'); w.document.write('<meta charset=utf-8><title>Alertas por día</title><style>body{font:14px Arial;padding:16px}h2{margin:10px 0}</style>');
      Object.keys(porDia).sort().reverse().forEach(d=>{
        w.document.write('<h2>'+d+'</h2><ul>');
        porDia[d].forEach(a=> w.document.write('<li>'+fmtDate(a.ts)+' — '+a.nivel+' — '+a.titulo+' — '+a.agente+'</li>') );
        w.document.write('</ul>');
      });
      w.document.close();
    };

    // --- Accesos (simple)
    $('#btnAccesos').onclick = ()=>{
      const rows = state.accesses.slice(-100).reverse().map((a,i)=>{
        return \`<tr><td>\${i+1}</td><td>\${a.email}</td><td>\${fmtDate(a.at)}</td><td>\${a.blocked?'BLOQUEADO':'OK'}</td></tr>\`;
      }).join('');
      const html = \`
        <html><head><meta charset='utf-8'><title>Accesos</title>
        <style>body{font:13px Arial;padding:16px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:6px}</style>
        </head><body><h2>Accesos recientes</h2><table><thead><tr><th>#</th><th>Usuario</th><th>Fecha</th><th>Estado</th></tr></thead><tbody>\${rows}</tbody></table></body></html>\`;
      const w=window.open('','_blank'); w.document.write(html); w.document.close();
    };

    // --- enviar reporte rápido (se agrega como alerta)
    $('#btnEnviar').onclick = ()=>{
      if(!state.me) return toast('Inicia sesión primero');
      const a={
        id: Math.random().toString(16).slice(2,8),
        ts: Date.now(),
        nivel: $('#repNivel').value,
        tipo: $('#repTipo').value,
        titulo: $('#repMsg').value,
        agente: $('#orgLlamada').value,
        lat: $('#repLat').value || (-16.5 + Math.random()).toFixed(4),
        lng: $('#repLng').value || (-68.15 + Math.random()).toFixed(4)
      };
      state.alerts.unshift(a); render();
      toast('Reporte registrado');
    };

    // usar ubicación
    $('#btnLoc').onclick = ()=>{
      if(!navigator.geolocation) return toast('Geolocalización no disponible');
      navigator.geolocation.getCurrentPosition(p=>{
        const {latitude, longitude}=p.coords;
        $('#repLat').value = latitude.toFixed(6);
        $('#repLng').value = longitude.toFixed(6);
        if(map){ map.setView([latitude, longitude], 12); if(marker) map.removeLayer(marker); marker=L.marker([latitude,longitude]).addTo(map); }
      },()=>toast('No se pudo obtener ubicación'));
    };

    // --- render
    function render(){
      renderAlertList();
      $('#orgCount').textContent = '4 activos';
    }

    // --- boot
    initMap();
    // simulación de alertas en tiempo real
    setInterval(addFakeAlert, 5000);
    addFakeAlert(); addFakeAlert(); addFakeAlert();
    // mostrar login al entrar
    dlg.style.display='grid';
  </script>
</body>
</html>
