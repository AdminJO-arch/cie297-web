<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CIE-297 | Monitoreo en Tiempo Real</title>
  <link rel="icon" href="assets/logo.png" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-VcWg9GqTz8ZqS0MZqv6F4PFU9KqO1wH8HCr5p3p3pEg=" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-o9N1j7kGStb9b9j1rR6ZK72r3F4an2y1w6f1tTNQ+3E=" crossorigin=""/>
  <style>
    :root{
      --bg:#0b1424;--card:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
      --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    a{color:#8ab4ff;text-decoration:none}
    .brand{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;background:#0b1424;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--line)}
    .brand img{height:32px;width:32px;border-radius:6px;object-fit:cover}
    .brand h1{margin:0;font-size:18px;font-weight:800}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 10px 0}
    .btn{display:inline-flex;gap:.5rem;align-items:center;padding:.55rem .9rem;background:var(--soft);color:var(--text);
         border:1px solid var(--line);border-radius:10px;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .btn-ok{background:#072015;border-color:#0f3d2a}
    .btn-danger{background:#2a1212;border-color:#4a1e1e}
    .row{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.22rem .6rem;border-radius:999px;border:1px solid var(--line);font-weight:700;letter-spacing:.4px}
    .pill.low{background:#083518;border-color:#0b5c2f}
    .pill.med{background:#3a3000;border-color:#6f4c00}
    .pill.high{background:#3a0000;border-color:#6f1d1d}
    .legend{display:flex;gap:.5rem;align-items:center;font-size:12px;color:var(--muted)}
    .legend .pill{font-size:12px}
    .mapbox{border:1px dashed rgba(255,255,255,.12);border-radius:12px;overflow:hidden}
    #map{height:360px}
    .sidebar{display:flex;flex-direction:column;gap:16px}
    #alerts{max-height:410px;overflow:auto}
    .alert{background:var(--soft);border:1px solid var(--line);border-radius:12px;padding:.7rem .9rem;margin-bottom:10px}
    .alert .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem}
    .alert .msg{font-weight:600}
    .tiny{font-size:12px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 340px;gap:16px}
    .hidden{display:none !important}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:.55rem;border-bottom:1px solid var(--line);text-align:left}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--line);border-radius:999px;padding:.25rem .6rem;font-size:12px;color:var(--muted)}
    /* Alerts compact sidebar */
    .alerts-card .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem}
    .scroll{max-height:420px;overflow:auto}
    /* Admin only */
    #adminPanel .section{background:var(--soft);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:10px}
    #adminPanel details{border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:rgba(255,255,255,.02)}
    #adminPanel summary{cursor:pointer;font-weight:700}
    /* Access screen */
    #access{margin-bottom:16px}
    #access .btn{margin-left:8px}
    #loginModal{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center}
    #loginModal .box{width:520px;max-width:92vw;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    input,select,textarea{background:#0d1a2f;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:.6rem .7rem;width:100%}
    textarea{min-height:120px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field{margin-bottom:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    /* header buttons */
    .header-actions{margin-left:auto;display:flex;gap:8px}
  </style>
</head>
<body>
  <header class="brand">
    <img src="assets/logo.png" alt="CIE297" />
    <h1>CIE-297 | Monitoreo en Tiempo Real</h1>
    <div class="header-actions">
      <button id="btnLoginOpen" class="btn">Iniciar sesión</button>
      <button id="btnLogout" class="btn hidden">Cerrar sesión</button>
      <span id="who" class="chip hidden"></span>
    </div>
  </header>

  <div class="wrap">
    <!-- Access notice -->
    <div id="access" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Acceso</strong></div>
        <div class="tiny">Primero inicia sesión. El contenido del sistema se mostrará después.</div>
      </div>
    </div>

    <!-- Operational grid (hidden until login) -->
    <div id="main" class="hidden">
      <div class="split">
        <div>
          <div class="card">
            <h3>Área Operativa</h3>
            <div class="mapbox"><div id="map"></div></div>
            <div class="legend" style="margin-top:8px">
              <span>Leyenda:</span>
              <span class="pill low">BAJA</span>
              <span class="pill med">MEDIA</span>
              <span class="pill high">ALTA</span>
            </div>
          </div>

          <div class="card">
            <h3>Misiones / Reportes rápidos</h3>
            <div class="three">
              <div class="field"><label>Tipo</label>
                <select id="rTipo">
                  <option>Operativo en zona</option>
                  <option>Rebasado</option>
                  <option>Cambio de locación</option>
                  <option>Secuestro</option>
                  <option>Incautación de autos</option>
                  <option>Observación</option>
                  <option>Otros</option>
                </select>
              </div>
              <div class="field"><label>Nivel</label>
                <select id="rNivel">
                  <option value="ALTA">ALTA</option>
                  <option value="MEDIA">MEDIA</option>
                  <option value="BAJA">BAJA</option>
                </select>
              </div>
              <div class="field"><label>Usar ubicación</label>
                <button id="btnGeo" class="btn" type="button">Obtener</button>
              </div>
            </div>
            <div class="three">
              <div class="field"><label>Mensaje (indicativo)</label>
                <select id="rMensaje">
                  <option>PETA</option><option>LAMBO</option><option>TRICICLO</option><option>PATINETA</option>
                  <option>FRUTAS</option><option>MOTOBOMBA</option><option>CUCHARA</option><option>TENEDOR</option>
                  <option>CHISGUETE</option><option>PINTURA ROJA</option><option>PINTURA NARANJA</option><option>PINTURA AZUL</option>
                  <option>PINTURA VERDE</option><option>PINTURA AMARILLA</option><option>PINTURA CAFE</option><option>YENAS</option>
                  <option>LOBOS</option><option>LIEBRES</option><option>JUGANDO</option><option>RIO PILCOMAYO</option>
                  <option>LAGUNA ESCOBAR</option><option>MALLASA</option><option>CIELO NUBLADO</option><option>HOTEL RADISSON</option>
                  <option>HERRADURA</option><option>FEDERAL</option><option>CAIMAN</option><option>LAGARTOS</option>
                </select>
              </div>
              <div class="field"><label>Lat</label><input id="rLat" placeholder="lat" /></div>
              <div class="field"><label>Lng</label><input id="rLng" placeholder="lng" /></div>
            </div>
            <div class="field"><label>Descripción</label><textarea id="rDesc" placeholder="Detallar lo ocurrido..."></textarea></div>
            <div class="right"><button id="btnSend" class="btn btn-ok">Enviar</button></div>
          </div>
        </div>

        <aside class="sidebar">
          <div class="card">
            <h3>Órganos de búsqueda</h3>
            <div id="units"></div>
          </div>

          <div class="card alerts-card">
            <div class="header">
              <h3 style="margin:0">Alertas</h3>
              <span id="countChip" class="chip">0</span>
            </div>
            <div id="alerts" class="scroll"></div>
          </div>
        </aside>
      </div>

      <!-- Admin panel -->
      <div id="adminPanel" class="card hidden" style="margin-top:16px">
        <h3>Panel de administración</h3>
        <div class="right" style="margin-bottom:10px">
          <button id="btnExport" class="btn">Exportar PDF</button>
        </div>
        <details open class="section">
          <summary>Alertas (10 más recientes)</summary>
          <div id="adminAlerts" style="margin-top:8px;overflow:auto;max-height:320px">
            <table class="table">
              <thead><tr><th>ID</th><th>Fecha/Hora</th><th>Nivel</th><th>Título</th><th>Agente</th></tr></thead>
              <tbody id="adminAlertsBody"></tbody>
            </table>
          </div>
          <div class="right" style="margin-top:8px"><button id="btnVerTodas" class="btn">Ver todas</button></div>
        </details>

        <details class="section">
          <summary>Bitácora de búsqueda</summary>
          <div id="bitacoraWrap" class="tiny">Cargando...</div>
        </details>

        <details class="section">
          <summary>Accesos recientes / bloqueo</summary>
          <div id="accessWrap" class="tiny">Cargando...</div>
        </details>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal">
    <div class="box">
      <h3>Iniciar sesión</h3>
      <div class="two">
        <div class="field"><label>Email</label><input id="email" placeholder="usuario@cie297.mil" /></div>
        <div class="field"><label>Contraseña</label><input id="pass" type="password" placeholder="********" /></div>
      </div>
      <div class="right">
        <button id="btnLogin" class="btn">Entrar</button>
        <button id="btnCloseLogin" class="btn">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Dynamic API base (served by /config.js on your hosting) -->
  <script src="config.js"></script>
  <script>
    // Helpers
    const $ = (q) => document.querySelector(q);
    const api = () => (window.CIE297_API || '').replace(/\/$/, '');
    const auth = () => JSON.parse(localStorage.getItem('cie297_auth')||'null');
    const setAuth = (v)=> localStorage.setItem('cie297_auth', JSON.stringify(v));
    const isAdmin = () => (auth()?.role || '') === 'admin';

    // UI state
    function setViewSigned(signed){
      $('#access').classList.toggle('hidden', signed);
      $('#main').classList.toggle('hidden', !signed);
      $('#btnLoginOpen').classList.toggle('hidden', signed);
      $('#btnLogout').classList.toggle('hidden', !signed);
      $('#who').classList.toggle('hidden', !signed);
      if(signed){
        $('#who').textContent = (auth()?.grado || '') + ' ' + (auth()?.nombres || 'Usuario');
        $('#adminPanel').classList.toggle('hidden', !isAdmin());
      }
    }

    // Map
    let map, markers = [];
    function initMap(){
      map = L.map('map', { zoomControl:true }).setView([-16.5,-68.15], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }

    // Units (org de búsqueda) - simple mock with IEC SAT names
    const callsigns = ['ZEUS','ARIES','VIRGO','SAGITARIO','LIBRA','CAPRICORNIO','GEMINIS','ESCORPIO','TAURO','CANCER','LEO','PISCIS'];
    const canales = ['BLANCO','ROJO','AZUL','AMARILLO','VERDE','ROSADO','GUINDO','CARMESI','NEGRO','KAKI','MARRON','TURQUESA','CELESTE','NARANJA','PURPURA','GRIS'];
    function renderUnits(){
      const now = new Date();
      const html = callsigns.slice(0,4).map((n,i)=>{
        const canal = canales[i%canales.length];
        const fix = now.toISOString().slice(0,19).replace('T',' ');
        const lat = (-16.5 + Math.random()).toFixed(4), lng = (-68.1 + Math.random()).toFixed(4);
        return `<div class="alert" style="margin:0 0 10px 0">
          <div class="top">
            <strong>${n}</strong>
            <span class="tiny">${['EN MISIÓN','EN ESPERA','SIN SEÑAL'][i%3]}</span>
          </div>
          <div class="tiny">Canal ${canal} • Fix ${fix} • ${lat}, ${lng}</div>
        </div>`
      }).join('');
      $('#units').innerHTML = html;
    }

    // Alerts
    let alerts = [];
    function levelPill(level){
      const cls = level==='ALTA'?'high':(level==='MEDIA'?'med':'low');
      return `<span class="pill ${cls}">${level}</span>`;
    }
    function renderAlerts(){
      $('#countChip').textContent = alerts.length;
      $('#alerts').innerHTML = alerts.slice(-50).reverse().map(a=>`
        <div class="alert">
          <div class="top">
            <div class="row" style="gap:.5rem">
              ${levelPill(a.nivel)}
              <span class="tiny">${a.hora}</span>
            </div>
            <span class="tiny">${a.agente}</span>
          </div>
          <div class="msg">${a.titulo}</div>
          <div class="tiny">${a.lat && a.lng ? `${a.lat}, ${a.lng}` : ''}</div>
        </div>`).join('');
    }

    // Admin table
    function renderAdminTable(){
      const rows = alerts.slice(-10).reverse().map(a=>`
        <tr><td>${a.id}</td><td>${a.hora}</td><td>${a.nivel}</td><td>${a.titulo}</td><td>${a.agente}</td></tr>
      `).join('');
      $('#adminAlertsBody').innerHTML = rows || '<tr><td colspan="5" class="tiny">Sin datos</td></tr>';
    }

    // Simulated alerts every 5s
    function simTick(){
      const nivel = ['ALTA','MEDIA','BAJA'][Math.floor(Math.random()*3)];
      const agente = callsigns[Math.floor(Math.random()*callsigns.length)];
      const tipos = ['Interferencia RF','Geocerca violada','Movimiento anómalo','Actualización de posición','Incidente'];
      const a = {
        id: Math.random().toString(36).slice(2,8),
        hora: new Date().toLocaleString(),
        nivel, agente,
        titulo: tipos[Math.floor(Math.random()*tipos.length)],
        lat:(-16.5 + (Math.random()*0.2-0.1)).toFixed(4),
        lng:(-68.15 + (Math.random()*0.2-0.1)).toFixed(4)
      };
      alerts.push(a);
      renderAlerts();
      if(isAdmin()) renderAdminTable();
    }

    // Report send
    $('#btnSend').onclick = async ()=>{
      const payload = {
        tipo: $('#rTipo').value, nivel: $('#rNivel').value, mensaje: $('#rMensaje').value,
        lat: $('#rLat').value, lng: $('#rLng').value, desc: $('#rDesc').value
      };
      try{
        const res = await fetch(api()+'/api/report', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok) throw new Error('HTTP '+res.status);
        alert('Reporte enviado');
      }catch(e){
        alert('Report HTTP '+(e.message||e));
      }
    }
    $('#btnGeo').onclick = ()=>{
      if(!navigator.geolocation) return alert('GPS no disponible');
      navigator.geolocation.getCurrentPosition(pos=>{
        $('#rLat').value = pos.coords.latitude.toFixed(6);
        $('#rLng').value = pos.coords.longitude.toFixed(6);
      },()=>alert('No se pudo obtener ubicación'));
    };

    // Admin actions
    $('#btnExport').onclick = async ()=>{
      try{
        const res = await fetch(api()+'/api/admin/alerts/export?format=pdf');
        if(!res.ok) throw new Error('HTTP '+res.status);
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'reporte_alertas.pdf'; a.click();
        URL.revokeObjectURL(url);
      }catch(e){ alert('Exportación fallida: '+e.message); }
    };
    $('#btnVerTodas').onclick = async ()=>{
      try{
        const res = await fetch(api()+'/api/admin/alerts?all=1');
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        alerts = data || alerts;
        renderAlerts(); renderAdminTable();
      }catch(e){ alert('No se pudo cargar historial: '+e.message); }
    };

    // Access & login
    const modal = $('#loginModal');
    $('#btnLoginOpen').onclick = ()=> modal.style.display='flex';
    $('#btnCloseLogin').onclick = ()=> modal.style.display='none';
    $('#btnLogout').onclick = ()=>{ setAuth(null); location.reload(); };

    $('#btnLogin').onclick = async ()=>{
      const email = $('#email').value.trim(), pass = $('#pass').value.trim();
      try{
        const res = await fetch(api()+'/api/login', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,pass})});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        setAuth(data);
        modal.style.display='none';
        setViewSigned(true);
        initMap();
        renderUnits();
        renderAlerts();
        renderAdminTable();
      }catch(e){
        alert('Error login: '+e.message);
      }
    };

    // On load
    window.addEventListener('load', ()=>{
      const me = auth();
      if(me){ setViewSigned(true); initMap(); renderUnits(); renderAlerts(); if(isAdmin()) renderAdminTable(); }
      // simulator
      setInterval(simTick, 5000);
    });
  </script>
</body>
</html>
