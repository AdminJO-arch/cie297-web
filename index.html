<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CIE-297 | Monitoreo en Tiempo Real</title>
<link rel="icon" href="assets/logo.png"/>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0b1424;--card:#101b31;--soft:#12213b;--text:#e5ecff;--muted:#93a4c7;
  --ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--line:rgba(255,255,255,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
a{color:#8ab4ff;text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:16px}
.appbar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:#0b1424;position:sticky;top:0;z-index:20;border-bottom:1px solid var(--line)}
.brand{display:flex;gap:.5rem;align-items:center;font-weight:800;letter-spacing:.3px}
.brand img{width:30px;height:30px;border-radius:6px}
.actions{display:flex;gap:.5rem;align-items:center}
.btn{border:1px solid var(--line);background:var(--soft);color:var(--text);padding:.55rem .8rem;border-radius:.6rem}
.btn:hover{filter:brightness(1.1)}
.btn-danger{background:#18202d;border-color:#ff6b6b;color:#ff9aa9}
.badge{display:inline-block;padding:.15rem .6rem;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
.grid{display:grid;gap:16px}
.g-2{grid-template-columns:2fr 1fr}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;position:relative}
.card h3{margin:6px 0 12px 0}
.row{display:flex;gap:10px;align-items:center}
.control{width:100%;background:#0f182d;border:1px solid var(--line);border-radius:10px;padding:.55rem;color:var(--text)}
.control:focus{outline:0;border-color:#2c74ff}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:.55rem .6rem;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap}
th{color:var(--muted)}
.right{display:flex;align-items:center;gap:.5rem}
.chip{display:inline-block;padding:.22rem .6rem;border-radius:999px;font-weight:700;border:1px solid rgba(255,255,255,.15);letter-spacing:.5px}
.chip--media{background:#433000;border-color:var(--warn);color:#ffd166}
.chip--alta{background:#2a0005;border-color:#ff5b5b;color:#ff7b7b}
.chip--baja{background:#062f15;border-color:#22c55e;color:#86efac}
.alerts{max-height:420px;overflow:auto;padding-right:4px}
.item{border:1px solid var(--line);background:#0f182d;border-radius:14px;padding:.75rem .9rem;margin:.6rem 0}
.item .head{display:flex;gap:.5rem;align-items:center}
.item small{color:#8fa0c3}
/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(3,10,20,.6);backdrop-filter:saturate(120%) blur(1px);display:none;z-index:2000}
.modal{position:fixed;inset:0;display:none;justify-content:center;align-items:flex-start;padding:6vh 16px;z-index:2001}
.modal .panel{width:min(960px,96vw);max-height:88vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
.modal .panel .content{padding:18px}
.modal.open{display:flex}
.modal-backdrop.open{display:block}
body.modal-open{overflow:hidden;touch-action:none}
/* map box */
#map{height:360px;border:1px dashed var(--line);border-radius:10px}
.legend{display:flex;gap:.6rem;margin-top:10px}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.dot.g{background:#22c55e}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
footer{opacity:.7;text-align:center;margin:36px 0}
.hidden{display:none !important}
</style>
</head>
<body>
<header class="appbar">
  <div class="brand"><img src="assets/logo.png" alt="logo"/><span>CIE-297 | Monitoreo en Tiempo Real</span></div>
  <div class="actions">
    <button id="btnOpenAuth" class="btn">Iniciar sesión</button>
    <button id="btnLogout" class="btn hidden">Cerrar sesión</button>
  </div>
</header>

<main class="container grid g-2">
  <section class="card">
    <h3>Área Operativa</h3>
    <div id="map"></div>
    <div class="legend">
      <span class="chip chip--baja"><span class="dot g"></span>BAJA</span>
      <span class="chip chip--media"><span class="dot y"></span>MEDIA</span>
      <span class="chip chip--alta"><span class="dot r"></span>ALTA</span>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Misiones / Reportes rápidos</h3>
      <div class="row">
        <select id="tipo" class="control" style="max-width:260px">
          <option>Operativo en zona</option>
          <option>Rebasado</option>
          <option>Incautación de autos</option>
        </select>
        <select id="nivel" class="control" style="max-width:140px">
          <option value="ALTA">ALTA</option>
          <option value="MEDIA">MEDIA</option>
          <option value="BAJA">BAJA</option>
        </select>
        <button id="btnGeo" class="btn">Usar ubicación</button>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="mensaje" class="control">
          <option>PETA</option><option>LAMBO</option><option>TRICICLO</option><option>PATINETA</option><option>FRUTAS</option><option>MOTOBOMBA</option><option>CUCHARA</option><option>TENEDOR</option><option>CHISGUETE</option><option>PINTURA ROJA</option><option>PINTURA NARANJA</option><option>PINTURA AZUL</option><option>PINTURA VERDE</option><option>PINTURA AMARILLA</option><option>PINTURA CAFE</option><option>YENAS</option><option>LOBOS</option><option>LIEBRES</option><option>JUGANDO</option><option>RIO PILCOMAYO</option><option>LAGUNA ESCOBAR</option><option>MALLASA</option><option>CIELO NUBLADO</option><option>HOTEL RADISSON</option><option>HERRADURA</option><option>FEDERAL</option><option>CAIMAN</option><option>LAGARTOS</option>
        </select>
        <input id="lat" class="control" placeholder="lat" style="max-width:160px"/>
        <input id="lng" class="control" placeholder="lng" style="max-width:160px"/>
      </div>
      <textarea id="desc" class="control" rows="3" placeholder="Detallar lo ocurrido..." style="margin-top:8px"></textarea>
      <div class="right" style="justify-content:flex-end;margin-top:10px">
        <button id="btnSend" class="btn">Enviar</button>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Alertas</h3>
      <div class="right">
        <button class="btn" id="btnAll">Ver todas</button>
        <button class="btn" id="btnPdf">Exportar PDF</button>
        <button class="btn" id="btnAccesos">Accesos</button>
      </div>
    </div>
    <div id="alerts" class="alerts"></div>

    <h3 style="margin-top:16px">Alertas (10 más recientes)</h3>
    <table id="tbl">
      <thead><tr><th>ID</th><th>Fecha</th><th>Nivel</th><th>Título</th><th>Agente</th></tr></thead>
      <tbody></tbody>
    </table>
  </aside>
</main>

<footer>© CIE-297 — Prototipo académico</footer>

<!-- MODAL AUTH -->
<div class="modal-backdrop" id="backdrop"></div>
<div class="modal" id="authModal" aria-hidden="true" role="dialog">
  <div class="panel">
    <div class="content">
      <h3 style="margin-top:0">Acceso</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <h4>Registro</h4>
          <div class="row"><select id="grado" class="control"><option>SLDO</option><option>SGT</option><option>SOF</option><option>SBTTE</option><option>TTE</option><option>CAP</option><option>MY</option><option>TCNL</option><option>CNL</option><option>GRAL</option></select></div>
          <div class="row"><input id="esp" class="control" placeholder="Especialidad"/></div>
          <div class="row"><input id="nom" class="control" placeholder="Nombres"/><input id="ape" class="control" placeholder="Apellidos"/></div>
          <div class="row"><input id="mail" class="control" placeholder="Email"/></div>
          <div class="row"><input id="pass" type="password" class="control" placeholder="Contraseña"/></div>
          <div class="right" style="justify-content:flex-end"><button id="btnReg" class="btn">Crear cuenta</button></div>
        </div>
        <div>
          <h4>Iniciar sesión</h4>
          <div class="row"><input id="lMail" class="control" placeholder="Email" value="admin@cie297.mil"/></div>
          <div class="row"><input id="lPass" type="password" class="control" placeholder="Contraseña" value="Admin123!"/></div>
          <div class="right"><button id="btnLogin" class="btn">Entrar</button><button id="btnClose" class="btn btn-danger">Cerrar</button></div>
        </div>
      </div>
      <p style="opacity:.7">Primero crea una cuenta o pulsa “Iniciar sesión”. El contenido del sistema se mostrará después.</p>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const state = {
  user:null,
  alerts: JSON.parse(localStorage.getItem('alerts')||'[]')
};

function openAuth(){ document.body.classList.add('modal-open'); $('#backdrop').classList.add('open'); $('#authModal').classList.add('open'); }
function closeAuth(){ document.body.classList.remove('modal-open'); $('#backdrop').classList.remove('open'); $('#authModal').classList.remove('open'); }

// Map
const map = L.map('map',{center:[-16.5,-68.15],zoom:6,zoomControl:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

// auth
$('#btnOpenAuth').onclick = openAuth;
$('#btnClose').onclick = closeAuth;
$('#backdrop').onclick = closeAuth;

$('#btnReg').onclick = () =>{
  const user = {grado:$('#grado').value, esp:$('#esp').value, nom:$('#nom').value, ape:$('#ape').value, mail:$('#mail').value, pass:$('#pass').value, admin:false};
  if(!user.mail||!user.pass){alert('Completa email y contraseña');return;}
  const users = JSON.parse(localStorage.getItem('users')||'[]');
  if(users.some(u=>u.mail===user.mail)){alert('Ya existe ese email');return;}
  users.push(user); localStorage.setItem('users',JSON.stringify(users));
  alert('Cuenta creada');
};

$('#btnLogin').onclick = () =>{
  const mail = $('#lMail').value.trim(), pass=$('#lPass').value.trim();
  if(mail==='admin@cie297.mil' && pass==='Admin123!'){ state.user={mail,admin:true,nom:'Administrador'}; }
  else{
    const users = JSON.parse(localStorage.getItem('users')||'[]');
    const u = users.find(u=>u.mail===mail && u.pass===pass);
    if(!u){ alert('Error login'); return; }
    state.user = u;
  }
  $('#btnOpenAuth').classList.add('hidden');
  $('#btnLogout').classList.remove('hidden');
  closeAuth();
  // registrar acceso
  const acc = JSON.parse(localStorage.getItem('accesos')||'[]');
  acc.push({mail:state.user.mail, ts:Date.now()});
  localStorage.setItem('accesos',JSON.stringify(acc));
};

$('#btnLogout').onclick = ()=>{ state.user=null; $('#btnLogout').classList.add('hidden'); $('#btnOpenAuth').classList.remove('hidden'); openAuth(); };

// Report quick
$('#btnGeo').onclick = ()=>{
  navigator.geolocation?.getCurrentPosition(p=>{
    $('#lat').value = p.coords.latitude.toFixed(6);
    $('#lng').value = p.coords.longitude.toFixed(6);
  }, ()=>alert('No se pudo obtener ubicación'));
};

function pushAlert(a){
  state.alerts.unshift(a);
  state.alerts=state.alerts.slice(0,200);
  localStorage.setItem('alerts',JSON.stringify(state.alerts));
  renderAlerts();
}
$('#btnSend').onclick = ()=>{
  if(!state.user){openAuth();return;}
  const a = {
    id: Math.random().toString(16).slice(2,8),
    ts: Date.now(),
    nivel: $('#nivel').value,
    titulo: $('#tipo').value,
    msg: $('#mensaje').value,
    user: state.user.mail,
    lat: $('#lat').value||(-16.5+Math.random()).toFixed(5),
    lng: $('#lng').value||(-68.15+Math.random()).toFixed(5)
  };
  pushAlert(a);
};

const nombres = ["ZEUS","ARIES","VIRGO","SAGITARIO","LIBRA","CAPRICORNIO","GEMINIS","ESCORPIO","TAURO","CANCER","LEO","PISCIS"];
const niveles = ["ALTA","MEDIA","BAJA"];
function simulate(){
  const a = {
    id: Math.random().toString(16).slice(2,7),
    ts: Date.now(),
    nivel: niveles[Math.floor(Math.random()*3)],
    titulo: nombres[Math.floor(Math.random()*nombres.length)]+" INCIDENTE",
    msg: ["INTERFERENCIA RF","GEO CERCA VIOLADA","MOVIMIENTO ANÓMALO","ACTUALIZACIÓN DE POSICIÓN"][Math.floor(Math.random()*4)],
    user: nombres[Math.floor(Math.random()*nombres.length)],
    lat: (-16.5+ (Math.random()-.5)).toFixed(5),
    lng: (-68.15+ (Math.random()-.5)).toFixed(5)
  };
  pushAlert(a);
}
setInterval(simulate,5000);

function pill(n){return n==="ALTA"?"chip chip--alta":n==="MEDIA"?"chip chip--media":"chip chip--baja";}
function renderAlerts(){
  const box = $('#alerts'); box.innerHTML='';
  state.alerts.slice(0,50).forEach(a=>{
    const li = document.createElement('div');
    li.className='item';
    li.innerHTML = `<div class="head">
       <span class="${pill(a.nivel)}">${a.nivel}</span>
       <small>${new Date(a.ts).toLocaleString()}</small>
     </div>
     <div style="margin-top:.35rem;font-weight:700">${a.user}</div>
     <small>${a.msg} — ${a.lat}, ${a.lng}</small>`;
    box.appendChild(li);
  });
  const tbody = $('#tbl tbody'); tbody.innerHTML='';
  state.alerts.slice(0,10).forEach(a=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.id}</td><td>${new Date(a.ts).toLocaleString()}</td><td>${a.nivel}</td><td>${a.msg}</td><td>${a.user}</td>`;
    tbody.appendChild(tr);
  });
}
renderAlerts();

// Ver todas
$('#btnAll').onclick = ()=>{
  const porDia={};
  state.alerts.forEach(a=>{ const d=new Date(a.ts).toISOString().slice(0,10); (porDia[d]||(porDia[d]=[])).push(a); });
  const w = window.open('','_blank');
  let html = '<html><head><title>Alertas</title><meta charset="utf-8"><style>body{font-family:system-ui;background:#0b1424;color:#e5ecff} table{border-collapse:collapse;width:100%} td,th{border:1px solid #203; padding:6px}</style></head><body>';
  html += '<h2>Alertas por día</h2>';
  Object.keys(porDia).sort().reverse().forEach(d=>{
     html +='<h3>'+d+'</h3><table><tr><th>ID</th><th>Fecha</th><th>Nivel</th><th>Título</th><th>Agente</th></tr>';
     porDia[d].forEach(a=>{ html+=`<tr><td>${a.id}</td><td>${new Date(a.ts).toLocaleString()}</td><td>${a.nivel}</td><td>${a.msg}</td><td>${a.user}</td></tr>`; });
     html +='</table>';
  });
  html+='</body></html>';
  w.document.write(html); w.document.close();
};
// Accesos
$('#btnAccesos').onclick = ()=>{
  const acc = JSON.parse(localStorage.getItem('accesos')||'[]').reverse();
  const w = window.open('','_blank');
  w.document.write('<meta charset="utf-8"><h2>Accesos</h2><ul>'+acc.map(a=>`<li>${new Date(a.ts).toLocaleString()} — ${a.mail}</li>`).join('')+'</ul>');
  w.document.close();
};

// PDF
$('#btnPdf').onclick = async()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const logo = new Image(); logo.src='assets/logo.png';
  await new Promise(r=>{ logo.onload=r; logo.onerror=r; });
  if(logo.width) doc.addImage(logo,'PNG',40,32,48,48);
  doc.setFontSize(16); doc.text('CIE-297 – Reporte de Alertas', 100, 50);
  doc.setFontSize(10); doc.text(new Date().toLocaleString(), 100, 66);
  // header
  let y=100;
  const rows = state.alerts.slice(0,10);
  doc.setFontSize(11);
  doc.text('ID',40,y); doc.text('Fecha',100,y); doc.text('Nivel',220,y); doc.text('Título',280,y); doc.text('Agente',470,y); y+=10;
  doc.setDrawColor(30); doc.line(40,y,555,y); y+=10;
  rows.forEach(a=>{
    doc.text(a.id,40,y); doc.text(new Date(a.ts).toLocaleTimeString(),100,y); doc.text(a.nivel,220,y); doc.text(a.msg,280,y); doc.text(a.user,470,y); y+=18;
  });
  doc.save('alertas.pdf');
};

// abrir modal al cargar si no hay sesión
openAuth();
</script>
</body>
</html>
